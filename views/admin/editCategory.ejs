
<%- include('../partials/admin/header') %>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<link rel="stylesheet" href="/css/dashboard.css">

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <link rel="stylesheet" href="/css/editCategory.css">
  

  

  <div class="container">
    <form class="reset-form" id="editCategoryForm">

      <h2 class="form-title">Edit Category</h2>

      <div class="form-group">
       <input
  type="text"
  name="name"
  class="form-input"
  id="categoryName"
  value="<%= category.name %>"
  placeholder="Category Name" >
        <span class="validation-icon" id="categoryNameIcon"></span>
        <div class="error-message" id="categoryNameError"></div>
      </div>

      <div class="form-group">
        <textarea
  name="description"
  class="form-input"
  id="description"
  placeholder="Description (Optional)"
  rows="4"><%= category.description %></textarea>
  
        <span class="validation-icon" id="descriptionIcon"></span>
        <div class="error-message" id="descriptionError"></div>
      </div>

      <button type="submit" class="reset-btn" id="submitBtn">Update Category</button>
    </form>
  </div>


  <script>

    
const form = document.getElementById("editCategoryForm");
const categoryInput = document.getElementById("categoryName");
const descriptionInput = document.getElementById("description");
const submitBtn = document.getElementById("submitBtn");

let originalCategoryName = "";
let originalDescription = "";
let existingCategories = [];
let categoryId = "";
// Get category ID from URL
const pathSegments = window.location.pathname.split('/');
categoryId = pathSegments[pathSegments.length - 1];


window.addEventListener("DOMContentLoaded", () => {
  originalCategoryName = categoryInput.value.trim();
  originalDescription = descriptionInput.value.trim();
});



// Load category data from server


// Validate category name
function validateCategoryName(value) {
  const errors = [];
  const trimmed = value.trim();

  if (!trimmed) {
  errors.push("Category name is required");
}

if (trimmed.length < 2) {
  errors.push("Category name must be at least 2 characters");
}

if (trimmed.length > 50) {
  errors.push("Category name must be no more than 50 characters");
}

if (! /^[a-zA-Z0-9\s&\-_,.'â€™()]+$/.test(trimmed)) {
  errors.push("Only letters, numbers, spaces, and basic symbols are allowed");
}

if (
  existingCategories.some(
    cat =>
      cat.toLowerCase() === trimmed.toLowerCase() &&
      trimmed.toLowerCase() !== (originalCategoryName || "").toLowerCase()
  )
) {
  errors.push("Category name already exists");
}
return errors;
}

// Validate description
function validateDescription(value) {
  const trimmed = value.trim();
  if (trimmed.length > 500) return ["Description must be less than 500 characters"];
  return [];
}

// Show validation feedback
function showValidation(input, errors) {
  const errorDiv = document.getElementById(input.id + "Error");
  if (errors.length > 0) {
    input.classList.add("error");
    input.classList.remove("success");
    errorDiv.textContent = errors[0];
  } else {
    input.classList.add("success");
    input.classList.remove("error");
    errorDiv.textContent = "";
  }
}

// Validate entire form
function validateForm() {
  const categoryErrors = validateCategoryName(categoryInput.value);
  const descriptionErrors = validateDescription(descriptionInput.value);

  showValidation(categoryInput, categoryErrors);
  showValidation(descriptionInput, descriptionErrors);

  return categoryErrors.length === 0 && descriptionErrors.length === 0;
}

// Real-time validation
categoryInput.addEventListener("input", () => validateForm());
descriptionInput.addEventListener("input", () => validateForm());

// Form submission
form.addEventListener("submit", async (e) => {
  e.preventDefault();

  if (!validateForm()) {
    Swal.fire({ icon: "error", title: "Validation Error", text: "Please fix the errors", confirmButtonColor: "#333" });
    return;
  }

  const categoryName = categoryInput.value.trim();
  const description = descriptionInput.value.trim();

  if (categoryName === originalCategoryName && description === originalDescription) {
    Swal.fire({ icon: "info", title: "No Changes", text: "Nothing to update", confirmButtonColor: "#333" });
    return;
  }

  const result = await Swal.fire({
    title: "Confirm Update",
    text: `Update category to "${categoryName}"?`,
    icon: "question",
    showCancelButton: true,
    confirmButtonColor: "#dc3545",
    cancelButtonColor: "#28a745",
    confirmButtonText: "Yes, update it!"
  });

  if (result.isConfirmed) {
    try {
      submitBtn.disabled = true;
      submitBtn.textContent = "Updating...";

      const formData = new FormData();
      formData.append("name", categoryName);
      formData.append("description", description);

  
      const response = await fetch(`/admin/edit/${categoryId}`, {
  method: "POST",
  body: formData
});

      const data = await response.json();

      if (response.ok && data.success) {
        Swal.fire({ icon: "success", title: "Updated!", text: "Category updated successfully", confirmButtonColor: "#333" })
             .then(() => window.location.href = "/admin/category");
      } else {
        throw new Error(data.message || "Update failed");
      }
    } catch (error) {
      console.error(error);
      Swal.fire({ icon: "error", title: "Update Failed", text: error.message, confirmButtonColor: "#333" });
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "Update Category";
    }
  }
});




</script>

</body>
</html>