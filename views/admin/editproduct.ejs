<%- include('../partials/admin/header') %>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Products</title>
    <link rel="stylesheet" href="/css/addproduct.css">
    <link rel="stylesheet" href="/css/dashboard.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <button class="back-btn" onclick="goBack()">‚Üê</button>
                <h1 class="header-title">Add Products</h1>
            </div>
        </div>

        <!-- Form -->
        <div class="form-container">
            <form id="productForm" method="POST" action="/admin/editProduct/<%= product._id %>" enctype="multipart/form-data">
                <!-- Image Upload Section -->
                <div class="upload-section">
                    <div class="upload-grid">
                        <div class="upload-box" onclick="triggerFileInput('photo1')">
                            <div class="camera-icon">üì∑</div>
                        </div>
                        <div class="upload-box" onclick="triggerFileInput('photo2')">
                            <div class="camera-icon">üì∑</div>
                        </div>
                        <div class="upload-box" onclick="triggerFileInput('photo3')">
                            <div class="camera-icon">üì∑</div>
                        </div>
                    </div>
                    <div class="upload-labels">
                        <div class="upload-label">Upload Photo 1</div>
                        <div class="upload-label">Upload Photo 2</div>
                        <div class="upload-label">Upload Photo 3</div>
                    </div>
                </div>

                <!-- File Inputs -->
                <input type="file" name="productImage" id="photo1" class="file-input" accept="image/*" onchange="handleFileUpload(this, 0)">
                <input type="file" name="productImage" id="photo2" class="file-input" accept="image/*" onchange="handleFileUpload(this, 1)">
                <input type="file" name="productImage" id="photo3" class="file-input" accept="image/*" onchange="handleFileUpload(this, 2)">

                <!-- Product Name -->
                <div class="form-group">
                    <label class="form-label">Product Name</label>
                    <input type="text" name="productName" class="form-input" placeholder="Enter product name" value="<%= product.productName %>">
                    <div id="productName-error" class="error-message"></div>
                </div>

                <!-- Category -->
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" name="category">
                        <option value="">-- Select Category --</option>
                        <% for(let i = 0; i < category.length; i++) { %>
                            <option value="<%= category[i].name %>" <%= product.category === category[i].name ? 'selected' : '' %>><%= category[i].name %></option>
                        <% } %>
                    </select>
                    <div id="category-error" class="error-message"></div>
                </div>

                <!-- Sale Price -->
                <div class="form-group">
                    <label class="form-label">Sale Price</label>
                    <input type="text" name="salePrice" class="form-input" placeholder="Enter sale price" value="<%= product.salePrice %>">
                    <div id="salePrice-error" class="error-message"></div>
                </div>

                <!-- Quantity -->
                <div class="form-group">
                    <label class="form-label">Stock Count</label>
                    <input type="number" name="quantity" class="form-input" placeholder="Enter stock count" value="<%= product.quantity %>">
                    <div id="quantity-error" class="error-message"></div>
                </div>

                <!-- Description -->
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" name="description" class="form-input" placeholder="Enter description" value="<%= product.description %>">
                    <div id="description-error" class="error-message"></div>
                </div>

                <!-- Color -->
                <div class="form-group">
                    <label class="form-label">Color</label>
                    <select class="form-select" name="color">
                        <option value="">-- Select Color --</option>
                        <option value="red" <%= product.color === 'red' ? 'selected' : '' %>>Red</option>
                        <option value="blue" <%= product.color === 'blue' ? 'selected' : '' %>>Blue</option>
                    </select>
                    <div id="color-error" class="error-message"></div>
                </div>

                <!-- Size -->
                <div class="form-group">
                    <label class="form-label">Size</label>
                    <select class="form-select" name="size">
                        <option value="">-- Select Size --</option>
                        <option value="M" <%= product.size === 'M' ? 'selected' : '' %>>M</option>
                        <option value="L" <%= product.size === 'L' ? 'selected' : '' %>>L</option>
                    </select>
                </div>

                <!-- Submit -->
                <button type="submit" class="add-btn">Update Product</button>
            </form>
        </div>
    </div>

    <script>
        // Trigger file input
        function triggerFileInput(inputId) {
            document.getElementById(inputId).click();
        }

        // Show preview
        function handleFileUpload(input, index) {
            const file = input.files[0];
            if (file) {
                const uploadBox = document.querySelectorAll('.upload-box')[index];
                uploadBox.classList.add('active');
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadBox.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px;">`;
                };
                reader.readAsDataURL(file);
            }
        }

        // Go back button
        function goBack() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                alert('No previous page to go back to');
            }
        }

        // Display error
        function displayErrorMessage(id, message) {
            const el = document.getElementById(id);
            if (el) el.textContent = message;
        }

        // Clear previous errors
        function clearErrors() {
            document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
        }

        // Validate form
        function validateForm() {
            clearErrors();
            let valid = true;

            const name = document.getElementsByName('productName')[0].value.trim();
            const description = document.getElementsByName('description')[0].value.trim();
            const salePrice = document.getElementsByName('salePrice')[0].value.trim();
            const quantity = document.getElementsByName('quantity')[0].value.trim();
            const color = document.getElementsByName('color')[0].value.trim();
            const category = document.getElementsByName('category')[0].value.trim();
            const images = [
                document.getElementById('photo1').files.length,
                document.getElementById('photo2').files.length,
                document.getElementById('photo3').files.length
            ];

            if (!name) {
                displayErrorMessage('productName-error', 'Please enter a product name.');
                valid = false;
            }

            if (!category) {
                displayErrorMessage('category-error', 'Please select a category.');
                valid = false;
            }

            if (!salePrice || !/^\d+(\.\d{1,2})?$/.test(salePrice) || parseFloat(salePrice) < 0) {
                displayErrorMessage('salePrice-error', 'Please enter a valid sale price.');
                valid = false;
            }

            if (!quantity || parseInt(quantity) < 0) {
                displayErrorMessage('quantity-error', 'Please enter a valid quantity.');
                valid = false;
            }

            if (!description) {
                displayErrorMessage('description-error', 'Please enter a description.');
                valid = false;
            }

            if (!color) {
                displayErrorMessage('color-error', 'Please select a color.');
                valid = false;
            }

            if (images.every(len => len === 0)) {
                alert('Please upload at least one image.');
                valid = false;
            }

            return valid;
        }

        // Attach to form
        document.getElementById('productForm').addEventListener('submit', function(e) {
            if (!validateForm()) {
                e.preventDefault();
            }
        });
    </script>
</body>
</html>
