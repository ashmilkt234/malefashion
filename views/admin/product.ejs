  <%- include('../partials/admin/header') %>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
 <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/css/product.css">
<link rel="stylesheet" href="/css/dashboard.css">



<!-- <link rel="stylesheet" href="/css/productt.css"> -->



  <div class="main-content ">
  
    <div class="container p-4 bg-white rounded shadow" style="margin-top: 7px;">
  
      <div class="d-flex justify-content-between align-items-center mb-4">
        <button class="back-btn" onclick="goBack()">← Back</button>
        <h3 style="margin-left: 100px;">Products</h3>

        <!-- Search Bar -->
        <form method="GET" action="/admin/product" class="d-flex me-2">
          <input type="text" name="search" class="form-control" placeholder="Search Products..." value="<%= searchQuery || '' %>">
          <button class="btn btn-secondary ms-1"><i class="fa fa-search"></i></button>
            <a href="/admin/product" class="btn btn-secondary clear-btn" style=" padding: 4px 10px;
    font-size: 12px; margin-left: 6px;" >Clear</a>
        </form>

        <!-- Add Product Button -->
        <a href="/admin/addProduct" class="btn btn-primary"><i class="fa fa-plus"></i> Add</a>
      </div>

      <!-- Product Table -->
      <table class="table table-bordered table-hover text-center align-middle">
        <thead class="table-light">
          <tr>
            <th>Product Name</th>
            <th>Category</th>
               <th>Description</th>
          <th>Soft Delete</th>
            <th>Price</th>
            <th>Stock</th> 
            <th>Action</th>
            <th>Edit</th>
          </tr>
        </thead>

      <tbody>
       

  <% if (data && data.length > 0) { %>
    <% data.forEach(product => { %>
      <tr>
        <td><%= product.productName %></td>

        <td><%= product.category ? product.category.name : "No Category" %></td>

        <td><%= product.description %></td>

 <td>
  <% if (!product.isDeleted) { %>
    <button class="btn btn-danger btn-sm"
      onclick="confirmDelete('<%= product._id %>')">
      Delete
    </button>
  <% } else { %>
    <button class="btn btn-success btn-sm"
      onclick="confirmRestore('<%= product._id %>')">
      Restore
    </button>
  <% } %>
</td>

        <td>₹<%= product.salesPrice %></td>

        <!--  Stock will always be 200+ -->
        <td><%= product.quantity %></td>

        <td>
          <% if (!product.isBlocked) { %>
            <button class="btn btn-danger btn-sm"
              onclick="confirmBlock('<%= product._id %>')">
              Block
            </button>
          <% } else { %>
            <button class="btn btn-success btn-sm"
              onclick="confirmUnblock('<%= product._id %>')">
              Unblock
            </button>
          <% } %>
        </td>

        <td>
          <a href="/admin/editProduct/<%= product._id %>"
             class="btn btn-warning btn-sm text-dark">
            Edit
          </a>
        </td>
      </tr>
    <% }) %>
  <% } else { %>
    <tr>
      <td colspan="8" class="text-center">No products with stock ≥ 200</td>
    </tr>
  <% } %>

        </tbody>
      </table>

      <!-- Pagination -->
      <div class="d-flex justify-content-center mt-4">
        <nav aria-label="Page navigation">
          <ul class="pagination">
            <% if (currentPage > 1) { %>
              <li class="page-item"><a class="page-link" href="?page=<%= currentPage - 1 %>&search=<%= searchQuery %>">&laquo; Previous</a></li>
            <% } %>

            <% for (let i = 1; i <= totalPages; i++) { %>
              <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                <a class="page-link" href="?page=<%= i %>&search=<%= searchQuery %>"><%= i %></a>
              </li>
            <% } %>

            <% if (currentPage < totalPages) { %>
              <li class="page-item"><a class="page-link" href="?page=<%= currentPage + 1 %>&search=<%= searchQuery %>">Next &raquo;</a></li>
            <% } %>
          </ul>
        </nav>
      </div>

    </div>
  </div>

  <!-- SweetAlert Script -->

    <script>

      function goBack() {
            window.history.back();
        }
 function confirmBlock(productId) {
  swal({
    title: "Block Product?",
    text: "This product will not be visible to customers.",
    icon: "warning",
    buttons: ["Cancel", "Yes, Block"],
    dangerMode: true,
  }).then(async(willblock)=>{
    if(willblock){
      try {
        const response=await fetch(`/admin/product/${productId}/block`, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json"
          }
        });
        const data=await response.json()
        if(response.ok&&data.success){
          swal("Blocked!",data.message,"success")
          .then(()=>window.location.reload())
        }else{
          swal("Error", data.message || "Failed to block product", "error");
        }
      } catch (error) {
        swal("Error", "Server error", "error");
      }
    }
  })
 }

function confirmUnblock(productId) {
  swal({
    title: "Unblock Product?",
    text: "This product will be visible to customers again.",
    icon: "info",
    buttons: ["Cancel", "Yes, Unblock"],
  }).then(async (willUnblock) => {
    if (willUnblock) {
      try {
        const response = await fetch(`/admin/product/${productId}/unblock`, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json"
          }
        });

        const data = await response.json();

        if (response.ok && data.success) {
          swal("Unblocked!", data.message, "success")
            .then(() => window.location.reload());
        } else {
          swal("Error", data.message || "Failed to unblock product", "error");
        }
      } catch (error) {
        swal("Error", "Server error", "error");
      }
    }
  });
}


function confirmDelete(id) {
  Swal.fire({
    title: "Delete Product?",
    text: "Product will be hidden from users",
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "Yes, delete"
  }).then(async (result) => {
    if (result.isConfirmed) {
      const res = await fetch(`/admin/product/${id}/soft-delete`, {
        method: "POST"
      });
      const data = await res.json();

      if (data.status) {
        Swal.fire("Deleted!", data.message, "success")
          .then(() => location.reload());
      }
    }
  });
}

function confirmRestore(id) {
  Swal.fire({
    title: "Restore Product?",
    icon: "info",
    showCancelButton: true,
    confirmButtonText: "Restore"
  }).then(async (result) => {
    if (result.isConfirmed) {
      const res = await fetch(`/admin/product/${id}/restore`, {
        method: "POST"
      });
      const data = await res.json();

      if (data.status) {
        Swal.fire("Restored!", data.message, "success")
          .then(() => location.reload());
      }
    }
  });
}

 
</script>

