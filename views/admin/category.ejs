<%- include('../partials/admin/header') %>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="/css/category.css" />
<link rel="stylesheet" href="/css/dashboard.css">

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Added wrapper -->
<div class="main-content" style="margin-left: 190px; padding: 80px; margin-top:0;">
  <div class="container p-4 bg-white rounded shadow" style="margin-top: 10px;">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3 style="margin-left: 100px; margin-bottom: -5px;">Category</h3>
<!--search bar-->
<div class="search-container">
  <form action="/admin/category" method="GET">
    <input type="text" placeholder="Search.." name="search" value="<%= searchQuery || '' %>">
    <button type="submit"><i class="fa fa-search"></i></button>
      <a href="/admin/category" class="btn btn-secondary clear-btn"   style=" padding: 4px 10px;
    font-size: 12px;margin-left: 6px;" 
    >Clear</a>
  </form>
</div>



      <a href="/admin/addCategory" class="btn btn-primary">Add</a>
    </div>

    <table class="table table-bordered table-hover align-middle text-center">
      <thead class="table-light">
        <tr>
          <th>Category Name</th>
          <th>Description</th>
      <th>SoftDelete</th>
          <th>Size</th>
          <th>Offer Price</th>
          <th>Offer</th>
          <th>Status</th>
          <th>Action</th>
          <th>Created Date</th>

        </tr>
      </thead>
      <tbody>
        <% categories.forEach((category, index) => { %>
          <tr>
            <td><%= category.name %></td>
            <td><%= category.description %></td>
            <td>
  <% if (!category.isDeleted) { %>
    <!-- DELETE -->
    <form action="/admin/category/delete/<%= category._id %>" method="POST" style="display:inline;">
      <button type="submit" class="btn btn-danger btn-sm"
        onclick="return confirm('Delete this category?')">
        Delete
      </button>
    </form>
  <% } else { %>
    <!-- RESTORE -->
    <form action="/admin/category/restore/<%= category._id %>" method="POST" style="display:inline;">
      <button type="submit" class="btn btn-success btn-sm"
        onclick="return confirm('Restore this category?')">
        Restore
      </button>
    </form>
  <% } %>
</td>

   
<td>
  <% if (category.hasSize) { %>
    <span class="badge bg-success">Yes</span>
  <% } else { %>
    <span class="badge bg-secondary">No</span>
  <% } %>
</td>

            <td><%= category.categoryOffer ? category.categoryOffer + '%' : '0%' %></td>
            <!-- <td><%= category.createdAt.toLocaleDateString('en-IN') %></td> -->
            <td>
              <% if (category.categoryOffer) { %>
                <button class="btn btn-danger btn-sm" onclick="removeOffer('<%= category._id %>')">Remove</button>
              <% } else { %>
                <button class="btn btn-success btn-sm" onclick="addOffer('<%= category._id %>')">Add Offer</button>
              <% } %>
            </td>
            <td>
              <% if (category.isListed) { %>
                <button class="btn btn-warning btn-sm" onclick="updateCategoryStatus('<%= category._id %>', false)">Unlist</button>
              <% } else { %>
                <button class="btn btn-success btn-sm" onclick="updateCategoryStatus('<%= category._id %>', true)">List</button>
              <% } %>
            </td>
            <td>
  <a href="/admin/category/edit/<%= category._id %>" class="text-dark text-decoration-none">
    <i class="bi bi-pencil-square fs-5">edit</i>
  </a>
</td>

           <td> <%= category.createdAt.toLocaleDateString('en-IN') %></td>

          </tr>
        <% }) %>
      </tbody>
    </table>

    <div class="d-flex justify-content-center mt-4">
      <nav aria-label="Page navigation">
        <ul class="pagination">
          <% if (currentPage > 1) { %>
            <li class="page-item"><a class="page-link" href="?page=<%= currentPage - 1 %>">&laquo; Previous</a></li>
          <% } %>
          <% for (let i = 1; i <= totalPages; i++) { %>
            <% if (i === currentPage) { %>
              <li class="page-item active"><span class="page-link"><%= i %></span></li>
            <% } else { %>
              <li class="page-item"><a class="page-link" href="?page=<%= i %>"><%= i %></a></li>
            <% } %>
          <% } %>
          <% if (currentPage < totalPages) { %>
            <li class="page-item"><a class="page-link" href="?page=<%= currentPage + 1 %>">Next &raquo;</a></li>
          <% } %>
        </ul>
      </nav>
    </div>
  </div>
</div>
<!--  End wrapper -->
<style>
.search-container {
  display: flex;
  justify-content: flex-end;
}

.search-container input[type=text] {
  padding: 6px;
  font-size: 17px;
  border: none;
}

.search-container button {
  padding: 6px 10px;
  background: #ddd;
  font-size: 17px;
  border: none;
  cursor: pointer;
}

.search-container button:hover {
  background: #ccc;
}
</style>
<script>
  async function addOffer(categoryId) {
    const { value: amount } = await Swal.fire({
      title: "Offer in percentage",
      input: "number",
      inputLabel: "Percentage",
      inputPlaceholder: "%",
      inputAttributes: { min: 1, max: 100 },
      showCancelButton: true,
      confirmButtonText: "Add",
    });

    if (amount && !isNaN(amount) && amount > 0) {
      try {
        const response = await fetch("/admin/addCategoryOffer", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ percentage: amount, categoryId }),
        });

        const data = await response.json();
        if (response.ok && data.status === true) {
          Swal.fire("Success", "Offer has been added", "success").then(() => location.reload());
        } else {
          Swal.fire("Failed", data.message || "Adding offer failed", "error");
        }
      } catch (error) {
        Swal.fire("Error", "An error occurred while adding the offer", "error");
        console.error(error);
      }
    } else if (amount !== undefined) {
      Swal.fire("Invalid", "Please enter a valid percentage greater than 0", "warning");
    }
  }

  async function removeOffer(categoryId) {
    const result = await Swal.fire({
      title: "Are you sure?",
      text: "This will remove the offer from the category.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Yes, remove it!",
      cancelButtonText: "Cancel",
    });

    if (result.isConfirmed) {
      try {
        const response = await fetch("/admin/removeCategoryOffer", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ categoryId }),
        });

        const data = await response.json();
        if (response.ok && data.status === true) {
          Swal.fire("Removed!", "The offer has been removed.", "success").then(() => location.reload());
        } else {
          Swal.fire("Failed", data.message || "Removing offer failed", "error");
        }
      } catch (error) {
        Swal.fire("Error", "An error occurred while removing the offer", "error");
        console.error(error);
      }
    }
  }

  async function updateCategoryStatus(id, toList) {
    const url = toList ? `/admin/listCategory?id=${id}` : `/admin/unlistCategory?id=${id}`;
    try {
      const response = await fetch(url);
      if (response.redirected || response.ok) {
        Swal.fire("Updated", `Category has been ${toList ? "listed" : "unlisted"}`, "success").then(() => location.reload());
      } else {
        Swal.fire("Failed", "Could not update status", "error");
      }
    } catch (err) {
      Swal.fire("Error", "An error occurred", "error");
      console.error(err);
    }
  }


  
  </script>
