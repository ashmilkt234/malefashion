<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Products</title>
    <link rel="stylesheet" href="/css/addproduct.css">
    <link rel="stylesheet" href="/css/dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Croppie CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.css">
  
</head>
<body>
  <%- include('../partials/admin/header') %>

<div class="container">
    <div class="form-container">
        <form id="productForm" method="POST" action="/admin/addProduct" enctype="multipart/form-data">
            <!-- Image Upload Section -->
            <div class="upload-section">
                <div class="upload-grid">
                    <div class="upload-box" id="box0" onclick="triggerFileInput(0)">
                        <div class="camera-icon">ðŸ“·</div>
                        <span class="upload-text">Click to upload</span>
                    </div>
                    <div class="upload-box" id="box1" onclick="triggerFileInput(1)">
                        <div class="camera-icon">ðŸ“·</div>
                        <span class="upload-text">Click to upload</span>
                    </div>
                    <div class="upload-box" id="box2" onclick="triggerFileInput(2)">
                        <div class="camera-icon">ðŸ“·</div>
                        <span class="upload-text">Click to upload</span>
                    </div>
                </div>
                <div class="upload-labels">
                    <div class="upload-label">Upload Photo 1 </div>
                    <div class="upload-label">Upload Photo 2</div>
                    <div class="upload-label">Upload Photo 3</div>
                </div>
            </div>

            <!-- Hidden real file inputs (will hold cropped files) -->
            <input type="file" name="productImage" id="croppedInput0" style="display:none;">
            <input type="file" name="productImage" id="croppedInput1" style="display:none;">
            <input type="file" name="productImage" id="croppedInput2" style="display:none;">

            <!-- Temporary file inputs for selecting original images -->
            <input type="file" id="tempInput0" accept="image/*" style="display:none;">
            <input type="file" id="tempInput1" accept="image/*" style="display:none;">
            <input type="file" id="tempInput2" accept="image/*" style="display:none;">

            <!-- Product Name -->
            <div class="form-group">
                <label class="form-label">Product Name</label>
                <input type="text" name="productName" class="form-input" placeholder="Enter product name">
                <div id="productName-error" class="error-message"></div>
            </div>

            <!-- Category -->
            <div class="form-group">
                <label class="form-label">Category</label>
                <select class="form-select" name="category">
                    <option value="">-- Select Category --</option>
                    <% for(let i = 0; i < category.length; i++) { %>
                        <option value="<%= category[i].name %>"><%= category[i].name %></option>
                    <% } %>
                </select>
                <div id="category-error" class="error-message"></div>
            </div>
<!-- Product Sizes -->
<div class="form-group">
    <label class="form-label">Available Sizes</label>
    <div class="size-options">
        <label class="size-box">
            <input type="checkbox" name="sizes[]" value="S">
            <span>S</span>
        </label>

        <label class="size-box">
            <input type="checkbox" name="sizes[]" value="M">
            <span>M</span>
        </label>

        <label class="size-box">
            <input type="checkbox" name="sizes[]" value="L">
            <span>L</span>
        </label>
    </div>
    <div id="size-error" class="error-message"></div>
</div>

            <!-- Sale Price -->
            <div class="form-group">
                <label class="form-label">Sale Price</label>
                <input type="text" name="salesPrice" class="form-input" placeholder="Enter sale price">
                <div id="salePrice-error" class="error-message"></div>
            </div>

            <!-- Stock Count -->
            <div class="form-group">
                <label class="form-label">Stock Count</label>
                <input type="number" name="quantity" class="form-input" placeholder="Enter stock count">
                <div id="quantity-error" class="error-message"></div>
            </div>

            <!-- Description -->
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea name="description" class="form-input" placeholder="Enter description"></textarea>
                <div id="description-error" class="error-message"></div>
            </div>

            <button type="submit" class="add-btn">Add Now</button>
        </form>
    </div>
</div>

<!-- Cropper Modal -->
<div id="cropperModal" class="cropper-modal">
    <div class="cropper-container">
        <div class="cropper-header">
            <h3>Crop Image</h3>
            <button type="button" class="close-btn" onclick="closeCropper()">&times;</button>
        </div>
        <div id="croppie-demo"></div>
        <div class="cropper-footer">
            <button type="button" class="crop-btn" id="cropButton">Crop & Apply</button>
        </div>
    </div>
</div>

<!-- Croppie JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.js"></script>

<script>
let currentIndex = 0;
let croppieInstance = null;
let selectedFile = null;

// Trigger file selection
function triggerFileInput(index) {
    currentIndex = index;
    document.getElementById(`tempInput${index}`).click();
}

// Handle original image selection
document.querySelectorAll('[id^="tempInput"]').forEach(input => {
    input.addEventListener('change', function () {
        selectedFile = this.files[0];
        if (!selectedFile) return;

        const allowedTypes = ["image/png", "image/jpeg"];

        // BLOCK PDF & other files
        if (!allowedTypes.includes(selectedFile.type)) {
            Swal.fire({
                icon: "error",
                title: "Invalid File Format",
                text: "Only PNG and JPG images are allowed. PDF files are not supported.",
                confirmButtonColor: "#000"
            });

            this.value = "";       // clear input
            selectedFile = null;   // reset file
            return;                // STOP HERE
        }

     
        const reader = new FileReader();
        reader.onload = function (e) {
            openCropper(e.target.result);
        };
        reader.readAsDataURL(selectedFile);
    });
});


function openCropper(imageSrc) {
    document.getElementById('cropperModal').style.display = 'flex';

    const demoEl = document.getElementById('croppie-demo');
    demoEl.innerHTML = '';

    croppieInstance = new Croppie(demoEl, {
        viewport: { width: 300, height: 300, type: 'square' },
        boundary: { width: 400, height: 420 },
        showZoomer: true,
        enableExif: true,
        enableOrientation: true
    });

    croppieInstance.bind({
        url: imageSrc
    });
}

function closeCropper() {
    document.getElementById('cropperModal').style.display = 'none';
    if (croppieInstance) {
        croppieInstance.destroy();
        croppieInstance = null;
    }
}

// Apply crop and convert to File object
document.getElementById('cropButton').addEventListener('click', function() {
    if (!croppieInstance || !selectedFile) return;

    croppieInstance.result({
        type: 'blob',
        size: { width: 800, height: 800 },
        format: 'jpeg',
        quality: 0.95
    }).then(function(blob) {
        // Create File from blob
        const croppedFile = new File([blob], selectedFile.name, { type: 'image/jpeg' });

        // Update hidden real input
        const realInput = document.getElementById(`croppedInput${currentIndex}`);
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(croppedFile);
        realInput.files = dataTransfer.files;

        // Show preview
        const box = document.getElementById(`box${currentIndex}`);
        box.innerHTML = `<img src="${URL.createObjectURL(blob)}" style="width:100%; height:100%; object-fit:cover; border-radius:6px;">`;
        box.classList.add('active');

        closeCropper();
    });
});

// Validation
function validateForm() {
    clearErrors();
    let valid = true;

    const name = document.querySelector('[name="productName"]').value.trim();
    const description = document.querySelector('[name="description"]').value.trim();
    const sizesChecked = document.querySelectorAll('input[name="sizes[]"]:checked');
    const salesPrice = document.querySelector('[name="salesPrice"]').value.trim();
    const quantity = document.querySelector('[name="quantity"]').value.trim();
    const category = document.querySelector('[name="category"]').value;

    // Check at least one cropped image
    const hasImage = Array.from(document.querySelectorAll('[id^="croppedInput"]'))
        .some(input => input.files.length > 0);

    if (!hasImage) {
        Swal.fire({
            icon: 'warning',
            title: 'Missing Image',
            text: 'Please upload and crop at least one product image.',
            confirmButtonColor: '#3085d6'
        });
        valid = false;
    }

    if (!name || name.length < 3) {
        displayErrorMessage('productName-error', 'Product name must be at least 3 characters.');
        valid = false;
    }

    if (!category) {
        displayErrorMessage('category-error', 'Please select a category.');
        valid = false;
    }
    if (sizesChecked.length === 0) {
    displayErrorMessage('size-error', 'Please select at least one size.');
    valid = false;
}

    if (!salesPrice || !/^\d+(\.\d{1,2})?$/.test(salesPrice) || parseFloat(salesPrice) <= 0) {
        displayErrorMessage('salePrice-error', 'Enter a valid sale price greater than 0.');
        valid = false;
    }

    if (!quantity || isNaN(quantity) || parseInt(quantity) < 0) {
        displayErrorMessage('quantity-error', 'Enter a valid stock count.');
        valid = false;
    }

    if (!description || description.length < 10) {
        displayErrorMessage('description-error', 'Description must be at least 10 characters.');
        valid = false;
    }

    return valid;
}

function displayErrorMessage(id, message) {
    const el = document.getElementById(id);
    if (el) el.textContent = message;
}

function clearErrors() {
    document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
}

document.querySelector('[name="quantity"]').addEventListener('input', function() {
    if (this.value < 0) this.value = 0;
});

document.getElementById('productForm').addEventListener('submit', function(e) {
    if (!validateForm()) {
        e.preventDefault();
    }
});

// Success/Error messages
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('success')) {
    Swal.fire('Success!', urlParams.get('success'), 'success');
}
if (urlParams.get('error')) {
    Swal.fire('Error!', urlParams.get('error'), 'error');
}
</script>

<style>
.cropper-modal {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.cropper-container {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 520px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    overflow: hidden;
}

.cropper-header {
    padding: 15px 20px;
    background: #f8f9fa;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #eee;
}

.cropper-header h3 { margin: 0; font-size: 18px; }

.close-btn {
    background: none;
    border: none;
    font-size: 32px;
    cursor: pointer;
    color: #aaa;
}

.close-btn:hover { color: #000; }

#croppie-demo { margin: 20px auto; }

.cropper-footer {
    padding: 15px;
    text-align: center;
    background: #f8f9fa;
    border-top: 1px solid #eee;
}

.crop-btn {
    background: #000;
    color: white;
    border: none;
    padding: 12px 32px;
    border-radius: 6px;
    font-size: 16px;
    cursor: pointer;
}

.crop-btn:hover { background: #333; }

.upload-box {
    position: relative;
    cursor: pointer;
    border-radius: 8px;
    overflow: hidden;
    background: #f8f8f8;
    border: 2px dashed #ddd;
    transition: all 0.3s;
}

.upload-box:hover { border-color: #000; }

.upload-box.active { border: 2px solid #000; }

.camera-icon {
    font-size: 40px;
    color: #aaa;
    margin: 20px 0;
}

.upload-text {
    position: absolute;
    bottom: 8px;
    left: 0; right: 0;
    text-align: center;
    font-size: 13px;
    color: #666;
    pointer-events: none;
}

.upload-box.active .camera-icon,
.upload-box.active .upload-text {
    display: none;
}
</style>
</body>
</html>