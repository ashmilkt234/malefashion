<%- include('../partials/admin/header') %>

<link rel="stylesheet" href="/css/dashboard.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="/css/user-list.css">

<div class="main-content" style="margin-left: 190px; padding: 106px;">
  <div class="container p-4 bg-white rounded shadow">

    <!-- Header + Search -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3>Users</h3>

      <form method="GET" action="/admin/user" class="d-flex">
        <input
          type="text"
          name="search"
          class="form-control"
          placeholder="Search Users..."
          value="<%= search || '' %>">
        <button class="btn btn-secondary ms-2">
          <i class="fa fa-search"></i>
        </button>
        <a href="/admin/user" class="btn btn-secondary ms-2">Clear</a>
      </form>
    </div>

    <!-- Users Table -->
    <div class="table-responsive">
      <table class="table table-bordered text-center align-middle">
        <thead class="table-dark">
          <tr>
            <th>No</th>
            <th>Name</th>
            <th>Email</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>

        <tbody>
          <% if (users.length === 0) { %>
            <tr>
              <td colspan="5" class="fw-bold text-danger">No users found</td>
            </tr>
          <% } %>

          <% users.forEach((user, index) => { %>
            <tr>
              <td><%= (currentPage - 1) * limit + index + 1 %></td>
              <td><%= user.name %></td>
              <td><%= user.email %></td>

              <td>
                <% if (user.isBlocked) { %>
                  <span class="badge bg-danger">Blocked</span>
                <% } else { %>
                  <span class="badge bg-success">Active</span>
                <% } %>
              </td>

              <td>
                <% if (user.isBlocked) { %>
                  <button
                    type="button"
                    class="btn btn-sm btn-success unblock-btn"
                    data-id="<%= user._id %>">
                    <i class="fa-solid fa-unlock"></i> Unblock
                  </button>
                <% } else { %>
                  <button
                    type="button"
                    class="btn btn-sm btn-danger block-btn"
                    data-id="<%= user._id %>">
                    <i class="fa-solid fa-ban"></i> Block
                  </button>
                <% } %>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="d-flex justify-content-center mt-3">
      <ul class="pagination">
        <% if (currentPage > 1) { %>
          <li class="page-item">
            <a class="page-link" href="?page=<%= currentPage - 1 %>&search=<%= search %>">«</a>
          </li>
        <% } %>

        <% for (let i = 1; i <= totalPages; i++) { %>
          <li class="page-item <%= currentPage === i ? 'active' : '' %>">
            <a class="page-link" href="?page=<%= i %>&search=<%= search %>"><%= i %></a>
          </li>
        <% } %>

        <% if (currentPage < totalPages) { %>
          <li class="page-item">
            <a class="page-link" href="?page=<%= currentPage + 1 %>&search=<%= search %>">»</a>
          </li>
        <% } %>
      </ul>
    </div>

  </div>
</div>

<script>
document.addEventListener("click", (e) => {

  const blockBtn = e.target.closest(".block-btn");
  const unblockBtn = e.target.closest(".unblock-btn");

  if (blockBtn) {
    const id = blockBtn.dataset.id;

    Swal.fire({
      title: "Block this user?",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Yes, Block"
    }).then(async (result) => {
      if (result.isConfirmed) {
        await fetch(`/admin/user/${id}/block`, { method: "POST" });
        location.reload();
      }
    });
  }

  if (unblockBtn) {
    const id = unblockBtn.dataset.id;

    Swal.fire({
      title: "Unblock this user?",
      icon: "info",
      showCancelButton: true,
      confirmButtonText: "Yes, Unblock"
    }).then(async (result) => {
      if (result.isConfirmed) {
        await fetch(`/admin/user/${id}/unblock`, { method: "POST" });
        location.reload();
      }
    });
  }
});
</script>


